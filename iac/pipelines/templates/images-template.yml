parameters:
  major: $(grep -oP '^major=\K\d+' src/backend/version.txt)
  minor: $(grep -oP '^minor=\K\d+' src/backend/version.txt)
  TIME: $(date +%Y%m%d%H%M%S)
  registryName: iotimageacr
  GitBuildNumber: $(git rev-list --count HEAD)  
  pipelineAcrConnection: iotacr
  basePath: src/backend/
  dockerFilePath: infra/build/Dockerfile
  selectedImage: ''  
  images:
  - name: analyzer
    imageName: 'backend_analyzer'
    imagePath: ${{ parameters.basePath}}/analyzer
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: beapi
    imageName: 'backend_beapi'
    imagePath: ${{ parameters.basePath}}/beapi
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: infra
    imageName: 'backend_infra'
    imagePath: ${{ parameters.basePath}}/infra
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: mongowriter
    imageName: 'backend_mongowriter'
    imagePath: ${{ parameters.basePath}}/mongowriter
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: twinlistener
    imageName: 'backend_twinlistener'
    imagePath: ${{ parameters.basePath}}/twinlistener
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: unittests
    imageName: 'backend_unittests'
    imagePath: ${{ parameters.basePath}}/unittests
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: blobstreamer
    imageName: 'backend_blobstreamer'
    imagePath: ${{ parameters.basePath}}/Backend.BlobStreamer
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: iotlistener
    imageName: 'backend_iotlistener'
    imagePath: ${{ parameters.basePath}}/Backend.IoTListener
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: keyholder
    imageName: 'backend_keyholder'
    imagePath: ${{ parameters.basePath}}/Backend.KeyHolder
    imageVersion: ${{ parameters.major }}.${{ parameter.minor }}.${{ parameters.GitBuildNumber }}.${{ parameters.TIME }}
    dockerFilePath: ${{ parameters.basePath }}/${{ parameters.dockerFilePath }}
  - name: edge_conquest
    imageName: 'edge_conquest'
    imagePath: './src/edge/conquest/'
    imageVersion: 'v0.7.3'
    dockerFilePath: './src/edge/conquest/Dockerfile'
  

steps:
- ${{ each img in parameters.images }}:
  - ${{ if eq(parameters.selectedImage, img.name) }}:
    - script: |
        echo "##vso[task.setvariable variable=imageName;]${{ img.imageName }}"
        echo "##vso[task.setvariable variable=imageVersion;]${{ img.imageVersion }}"
        echo "##vso[task.setvariable variable=imagePath;]${{ img.imagePath }}"
        echo "##vso[task.setvariable variable=dockerFilePath;]${{ img.dockerFilePath }}"
      displayName: 'Set Image Information Variables for ${{ img.name }}'
  # Add more images as needed
