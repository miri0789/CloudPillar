# File: templates/scan.yml
parameters:
  imageName: ''
  imageVersion: ''
  registryName: ''
#   imagePath: ''
#   dockerFilePath: ''
  # pipelineAcrConnection: ''
  # pool: ''

  

steps:
- task: Bash@3
  # displayName: Scan Image
  displayName: 'Scan ${{ parameters.imageName }}'
  inputs:
    targetType: inline
    script: |
        az login --service-principal -u $(iac-app-client-id) -p $(iac-app-client-secret) --tenant $(ARM_TENANT_ID)
        az account set --subscription $(ARM_SUBSCRIPTION_ID)
        echo "Azure Login Successfull"
        sudo az acr login -n $(ACR_NAME)
        docker image ls
        echo "${{parameters.registryName}}.azurecr.io/${{parameters.imageName}}:${{parameters.imageVersion}}"
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL ${{parameters.registryName}}.azurecr.io/${{parameters.imageName}}:${{parameters.imageVersion}}
    name: scanImage

        # sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL ${{parameters.registryName}}.azurecr.io/${{parameters.imageName}}:${{parameters.imageVersion}}
        # sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL ${{parameters.imageName}}:${{parameters.imageVersion}}
        # sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image  --severity HIGH,CRITICAL ${{parameters.registryName}}.azurecr.io/${{parameters.imageName}}:${{parameters.imageVersion}}
        # sudo docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --severity HIGH,CRITICAL $(imageName):$(imageVersion)

        #   sed -i "s/_BUILDNUM_/${BuildNumber}/g; s/_TIMESTAMP_/${TIMESTAMP}/g" src/backend/${{parameters.imageName}}/${{parameters.imageName}}.csproj
    #   sudo docker build -t $(ACR_NAME).azurecr.io/backend_${{parameters.imageName}}.dll --build-arg DLL=backend_${{parameters.imageName}}.dll -f ./src/backend/infra/build/Dockerfile ./src/backend/${{parameters.imageName}}



