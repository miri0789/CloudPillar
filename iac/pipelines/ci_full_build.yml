
name: ci_full_test_$(Rev:r)

trigger:
  batch: true
  branches:
    include:
    - main
    - $(Build.SourceBranchName)
    exclude:
    - '*'
  paths:
    include:
    - src/edge/conquest/*
    - src/backned/*
    exclude:
    - '*'    

resources:
- repo: self

variables:
- group: arm-vg
- group: iac-backend-vg
- group: aks-backend-vg
- group: backend-secrets-vg

- name: major
  value: $(grep -oP '^major=\K\d+' src/backend/version.txt)
- name: minor
  value: $(grep -oP '^minor=\K\d+' src/backend/version.txt)
- name: TIME
  value: $(date +%Y%m%d%H%M%S)
- name: GitBuildNumber
  value: $(git rev-list --count HEAD)
- name: registryName
  value: 'iotimageacr'
# - name: dockerfilePath
#   value: './src/edge/conquest/Dockerfile'
- name: pipelineAcrConnection
  value: 'iotacr'
  # value: 'iotimageacr'
- name: isSelectedImageAll
  value: ${{ eq(parameters.image, 'all') }}





parameters:
  - name: env
    displayName: Select Environment to deploy
    type: string
    default: dev
    values:
    - tst
    - dev
    - stg
    - prd    
  - name: image
    displayName: Select Image to Build and Scan
    type: string
    default: all
    values:
    - beapi
    - edge_conquest
    - iotlistener
    - all
    - analyzer
    - blobstreamer
    - keyholder
    - mongowriter
    - twinlistener    

stages:



  - stage: GetImages # Stage 1
    jobs:
    - job: GetImagesJob
      displayName: Get Images Job
      steps:
      - task: Bash@3
        name: getImagesInfo
        inputs:
          targetType: 'inline'
          script: |
            images=$(cat ./src/backend/images.json | jq -c .) # Compact JSON
            echo "##vso[task.setvariable variable=images;isOutput=true]$images"
            echo "##vso[task.setvariable variable=images]$images"

            echo -e "\n\n===================================================================\n\tImages\n===================================================================\n"
            echo "$images"
            echo -e "\n\n"
        displayName: Set Images as Variable

  - stage: GetSingleImage # Stage 2
    dependsOn: GetImages
    condition: eq(variables['isSelectedImageAll'], false)
    jobs:
    - job: GetSingleImageJob
      variables:
        images: $[ stageDependencies.GetImages.GetImagesJob.outputs['getImagesInfo.images'] ]
      steps:
      - script: |
          imagesJson='$(images)'
          echo -e "\n\n===================================================================\n\tImages JSON\n===================================================================\n"
          echo "$imagesJson"
          echo -e "\n\n"
          for img in $(echo "${imagesJson}" | jq -r '.[] | @base64'); do
            _jq() {
              echo ${img} | base64 --decode | jq -r ${1}
            }
            imgName=$(_jq '.name')
            if [ "$imgName" == "${{ parameters.image }}" ]; then
              imageName=$(_jq '.imageName')
              imagePath=$(_jq '.imagePath')
              dockerFilePath=$(_jq '.dockerFilePath')
              imageVersion=$(_jq '.imageVersion')
              if [ "$imgName" != "edge_conquest" ]; then
                imageVersion="$(major).$(minor).$(GitBuildNumber).$(TIME)"
              fi
              echo "Processing image: $imgName"
              echo "Image Version: $imageVersion"
              echo "##vso[task.setvariable variable=imageName]$imageName"
              echo "##vso[task.setvariable variable=imageVersion]$imageVersion"
              echo "##vso[task.setvariable variable=imagePath]$imagePath"
              echo "##vso[task.setvariable variable=dockerFilePath]$dockerFilePath"

              echo "##vso[task.setvariable variable=imageName;isOutput=true]$imageName"
              echo "##vso[task.setvariable variable=imageVersion;isOutput=true]$imageVersion"
              echo "##vso[task.setvariable variable=imagePath;isOutput=true]$imagePath"
              echo "##vso[task.setvariable variable=dockerFilePath;isOutput=true]$dockerFilePath"
              # Further processing logic here
            fi
          done
        name: getSingleImagesInfo

  - stage: CleanBuildScanPush
    displayName: Build Tag Scan Push Image
    dependsOn: 
    - GetImages
    - GetSingleImage
    condition: eq(variables['isSelectedImageAll'], false)
    variables:
      images: $[ stageDependencies.GetImages.GetImagesJob.outputs['getImagesInfo.images']
      imageName: $[ stageDependencies.GetSingleImage.GetSingleImageJob.outputs['getSingleImagesInfo.imageName'] ]
      imageVersion: $[ stageDependencies.GetSingleImage.GetSingleImageJob.outputs['getSingleImagesInfo.imageVersion'] ]
      imagePath: $[ stageDependencies.GetSingleImage.GetSingleImageJob.outputs['getSingleImagesInfo.imagePath'] ]
      dockerFilePath: $[ stageDependencies.GetSingleImage.GetSingleImageJob.outputs['getSingleImagesInfo.dockerFilePath'] ]      

    jobs:
    - job: CleanImages
      displayName: Clean Images & Containers
      pool:
        name: $(AGENT_POOL)
        agent.name: aks-${{parameters.env}}-agent
      steps:
      - template: templates/clean.yml   

    - job: BuildTagImage
      dependsOn: CleanImages
      displayName: Build and Tag ${{ variables.imageName }}
      steps:
      - template: templates/build.yml
        parameters:
          imageName: $(imageName)
          imageVersion: $(imageVersion)
          imagePath: $(imagePath)
          dockerFilePath: $(dockerFilePath)
          registryName: $(registryName)

    - job: ScanImage
      dependsOn: BuildTagImage
      displayName: Scan Image $(imageName)
      steps:
      - template: templates/scan.yml
        parameters:
          imageName: $(imageName)
          imageVersion: $(imageVersion)
          registryName: $(registryName)

    - job: PushImage
      dependsOn: ScanImage
      displayName: Push Image $(imageName)
      steps:
      - template: templates/push.yml
        parameters:
          imageName: $(imageName)
          imageVersion: $(imageVersion)
          registryName: $(registryName)


    # - stage: CleanBuildScanPush
    #   displayName: Build Tag Scan Push Image
    #   dependsOn: 
    #   - GetImages
    #   - GetSingleImage
    #   condition: eq(variables['isSelectedImageAll'], true)
    #   variables:
    #     images: $[ stageDependencies.GetImages.GetImagesJob.outputs['getImagesInfo.images'] ]
    #   jobs:
    #     - ${{ if eq(variables.isSelectedImageAll, 'true') }}:
    #       - ${{ each image in variables.images }}:
    #         - job: BuildTag_${{ image.name }}
    #           displayName: Build and Tag ${{ image.name }}
    #           variables:
    #             imageName: ${{ image.imageName }}
    #             imageVersion: ${{ image.imageVersion }}
    #             imagePath: ${{ image.imagePath }}
    #             dockerFilePath: ${{ image.dockerFilePath }}            
    #           steps:
    #           - template: template/build.yml
    #             parameters:
    #               imageName: $(imageName)
    #               imageVersion: $(imageVersion)
    #               imagePath: $(imagePath)
    #               dockerFilePath: $(dockerFilePath)
    #               registryName: $(registryName)
    #               pipelineAcrConnection: $(pipelineAcrConnection)
    #         - job: Scan_${{ image.name }}
    #           displayName: Scan Image ${{ image.name }}
    #           variables:
    #             imageName: ${{ image.imageName }}
    #             imageVersion: ${{ image.imageVersion }}
    #             imagePath: ${{ image.imagePath }}
    #           steps:
    #           - template: template/scan.yml
    #             parameters:
    #               imageName: $(imageName)
    #               imageVersion: $(imageVersion)
    #               registryName: $(registryName)
    #         - job: Push_${{ image.name }}
    #           displayName: Push Image ${{ image.name }}
    #           variables:
    #             imageName: ${{ image.imageName }}
    #             imageVersion: ${{ image.imageVersion }}
    #             imagePath: ${{ image.imagePath }}
    #           steps:
    #           - template: template/push.yml
    #             parameters:
    #               imageName: $(imageName)
    #               imageVersion: $(imageVersion)
    #               registryName: $(registryName)


      # - job: CleanImages
      #   displayName: Clean Images & Containers
      #   pool:
      #     name: $(AGENT_POOL)
      #     agent.name: aks-${{parameters.env}}-agent
      #   steps:
      #   - template: templates/clean.yml              
      # - job: IterateImages
      #   steps:
      #   - script: |
      #       imagesJson='$(images)'
      #       echo -e "\n\n===================================================================\n\tImages JSON\n===================================================================\n"
      #       echo "$imagesJson"
      #       echo -e "\n\n"
      #       for img in $(echo "${imagesJson}" | jq -r '.[] | @base64'); do
      #         _jq() {
      #           echo ${img} | base64 --decode | jq -r ${1}
      #         }
      #         imgName=$(_jq '.name')



      # - job: BuildImageJob  
      #   displayName: Build ${{parameters.image}} Image
      #   dependsOn:
      #   - CleanImages
      #   pool:
      #     name: $(AGENT_POOL)
      #     agent.name: aks-${{parameters.env}}-agent
      #   steps:
      #   - script: |
      #       echo "##[group]BuildImageVars"
      #       echo "##[command]imageName:\t $(imageName)"
      #       echo "##[command]imageVersion:\t $(imageVersion)"
      #       echo "##[warning]imageVersion:\t $(imageVersion)"
      #       echo "##[warning]imageName:\t $(imageName)"
      #       echo "##[endgroup]"        
      #     name: DebugPrint
      #   - template: templates/build.yml
      #     parameters:
      #       imageName: $(imageName)
      #       imageVersion: $(imageVersion)
      #       imagePath: $(imagePath)
      #       dockerFilePath: $(dockerFilePath)
      #       registryName: $(registryName)
      #       pipelineAcrConnection: "$(pipelineAcrConnection)"


      #   # steps:
      #   # - script: |
      #   #     imagesJson='$(images)'
      #   #     echo -e "\n\n===================================================================\n\tImages JSON\n===================================================================\n"
      #   #     echo "$imagesJson"
      #   #     echo -e "\n\n"
      #   #     if [ "$(isSelectedImageAll)" != "true" ]; then



#     - job: CleanImages
#       displayName: Clean Images & Containers
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - template: templates/clean.yml              

#     - job: BuildImageJob  
#       displayName: Build ${{parameters.image}} Image
#       dependsOn:
#       - CleanImages
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]BuildImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"        
#         name: DebugPrint
#       - template: templates/build.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           imagePath: $(imagePath)
#           dockerFilePath: $(dockerFilePath)
#           registryName: $(registryName)
#           pipelineAcrConnection: "$(pipelineAcrConnection)"
#     - job: ScanImageJob
#       dependsOn: BuildImageJob 
#       displayName: Scan ${{parameters.image}} Image 
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       # variables:
#       # - name: imageName
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#       # - name: imageVersion
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#       # - name: imagePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#       # - name: dockerFilePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]
#       steps:
#       - script: |
#           echo "##[group]ScanImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"            
#         name: DebugPrint
#       - template: templates/scan.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)

#     - job: PushImageJob  
#       displayName: Push ${{parameters.image}} Image 
#       dependsOn: ScanImageJob
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]PushImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"        
#         name: DebugPrint    
#       - template: templates/push.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)



    # variables:
    # - name: imageName
    #   value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageName'] ]
    # - name: imageVersion
    #   value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageVersion'] ]
    # - name: imagePath
    #   value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imagePath'] ]
    # - name: dockerFilePath
    #   value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.dockerFilePath'] ]      



        #   semi_images=$(cat ./src/backend/images.json)
        #   json=$(cat src/backend/images.json)
        #   images='${{ variables.images }}'
        #   echo "images"
        #   echo "$images"
        #   imagesJson=$(echo "$images" | jq '.')
        #   echo "Images JSON"
        #   echo $imagesJson
        #   for row in $(echo "${imagesJson}" | jq -r '.[] | @base64'); do
        #     _jq() {
        #       echo ${row} | base64 --decode | jq -r ${1}
        #     }
        #     imgName=$(_jq '.name')
        #     if [ "$imgName" == "${{ parameters.image }}" ]; then
        #       imageVersion=$(_jq '.imageVersion')
        #       if [ "$imgName" != "edge_conquest" ]; then
        #         imageVersion="$(major).$(minor).$(GitBuildNumber).$(TIME)"
        #       fi
        #       echo "Processing image: $imgName"
        #       echo "Image Version: $imageVersion"
        #       # Further processing logic here
        #     fi
        #   done
        # displayName: Get Single Image Info

    #   - task: Bash@3
    #     name: getSingleImagesInfo
    #     inputs:
    #       targetType: 'inline'
    #       script: |
    # - ${{ if eq(parameters.selectedImage, img.name) }}:            
    #     displayName: Set Images as Variable
  




  
# - stage: ProcessAllImages
#   dependsOn: GetImages
#   variables:
#   - name: images
#     value: $[ stageDependencies.GetImages.GetImagesJob.outputs['getImagesInfo.images'] ]
#   jobs:
#   - job: ProcessImagesJob
#     steps:
#     - ${{ each img in variables['images'] }}:
#       - script: |
#           if [ "${{ img.name }}" == "edge_conquest" ]; then
#             imageVersion=${{ img.imageVersion }}
#           else
#             imageVersion=$(major).$(minor).$(GitBuildNumber).$(TIME)
#           fi
#           # Your processing logic here using $imageVersion, ${{ img.imageName }}, etc.
#         displayName: Process Image ${{ img.name }}







    # variables:
    # - name: images
    #   value: $[ stageDependencies.GetImages.GetImagesJob.outputs['getImagesInfo.images'] ]      
    
    # - ${{ each img in variables['images'] }}:
    #   jobs:
    #   - job: ProcessImagesJob
    #     steps:
    #     - ${{ each img in variables['images'] }}:
    #       - ${{ if eq(img.name, 'edge_conquest') }}:
    #         - script: echo "Using existing imageVersion for edge_conquest ${{img.imageVersion}}"
    #       - ${{ if (img.name, 'edge_conquest') }}:


#         - stage: ProcessImage_${{ parameters.image }}
#           displayName: Retrieve ${{ parameters.image }} Information
#           variables:
#           - name: imageVersion
#             value: $(major).$(minor).$(GitBuildNumber).$(TIME)
#           jobs:
#           - template: templates/images-template.yml
#             parameters:
#               registryName: $(registryName)
#               pipelineAcrConnection: $(pipelineAcrConnection)
#               selectedImage: ${{ img.name }}
#               imageVersion: $(imageVersion)
#         - stage: CleanBuildScanPush
#           displayName: Build Tag Scan Push Image
#           dependsOn: 
#           - ProcessImage_${{ img.name }}  
#           variables:
#           - name: imageName
#             value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageName'] ]
#           - name: imageVersion
#             value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageVersion'] ]
#           - name: imagePath
#             value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imagePath'] ]
#           - name: dockerFilePath
#             value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.dockerFilePath'] ]      
#           jobs:
#           - job: CleanImages
#             displayName: Clean Images & Containers
#             pool:
#               name: $(AGENT_POOL)
#               agent.name: aks-${{parameters.env}}-agent
#             steps:
#             - template: templates/clean.yml              

#           - job: BuildImageJob  
#             displayName: Build ${{img.name}} Image
#             dependsOn:
#             - CleanImages
#             pool:
#               name: $(AGENT_POOL)
#               agent.name: aks-${{parameters.env}}-agent
#             steps:
#             - script: |
#                 echo "##[group]BuildImageVars"
#                 echo "##[command]imageName:\t $(imageName)"
#                 echo "##[command]imageVersion:\t $(imageVersion)"
#                 echo "##[warning]imageVersion:\t $(imageVersion)"
#                 echo "##[warning]imageName:\t $(imageName)"
#                 echo "##[endgroup]"        
#               #   echo "Debugging BuildImage variables:"
#               #   echo "imageName: $(imageName)"
#               #   echo "imageVersion: $(imageVersion)"
#               name: DebugPrint
#             - template: templates/build.yml
#               parameters:
#                 imageName: $(imageName)
#                 imageVersion: $(imageVersion)
#                 imagePath: $(imagePath)
#                 dockerFilePath: $(dockerFilePath)
#                 registryName: $(registryName)
#                 pipelineAcrConnection: $(pipelineAcrConnection)
# - ${{ if ne(parameters.image, 'all') }}:
#   - ${{ each img in variables['images'] }}:
#     - ${{ if eq(parameters.image, img.name) }}:
#     - stage: ProcessSingleImage_${{ parameters.image }}
#       displayName: Retrieve ${{ parameters.image }} Information
#       variables:
#       - name: imageVersion
#         value: $(major).$(minor).$(GitBuildNumber).$(TIME)
#       jobs:
#     - template: templates/images-template.yml
#       parameters:
#         registryName: $(registryName)
#         pipelineAcrConnection: $(pipelineAcrConnection)
#         selectedImage: ${{ parameters.image }}
#         imageVersion: $(imageVersion)
#   - stage: CleanBuildScanPush
#     displayName: Build Tag Scan Push Image
#     dependsOn: 
#     - ProcessSingleImage_${{ parameters.image }}  
#     variables:
#     - name: imageName
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#     - name: imageVersion
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#     - name: imagePath
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#     - name: dockerFilePath
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]      
#     jobs:
#     - job: CleanImages
#       displayName: Clean Images & Containers
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - template: templates/clean.yml              

#     - job: BuildImageJob  
#       displayName: Build ${{parameters.image}} Image
#       dependsOn:
#       - CleanImages
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]BuildImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"        
#         name: DebugPrint
#       - template: templates/build.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           imagePath: $(imagePath)
#           dockerFilePath: $(dockerFilePath)
#           registryName: $(registryName)
#           pipelineAcrConnection: "$(pipelineAcrConnection)"
#     - job: ScanImageJob
#       dependsOn: BuildImageJob 
#       displayName: Scan ${{parameters.image}} Image 
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       # variables:
#       # - name: imageName
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#       # - name: imageVersion
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#       # - name: imagePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#       # - name: dockerFilePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]
#       steps:
#       - script: |
#           echo "##[group]ScanImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"            
#         name: DebugPrint
#       - template: templates/scan.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)

#     - job: PushImageJob  
#       displayName: Push ${{parameters.image}} Image 
#       dependsOn: ScanImageJob
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]PushImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"        
#         name: DebugPrint    
#       - template: templates/push.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)







# stages:
# - ${{ if eq(parameters.image, 'all') }}:
#   - ${{ each img in parameters.images }}:
#     - stage: ProcessImage_${{ parameters.image }}
#       displayName: Retrieve ${{ parameters.image }} Information
#       variables:
#       - name: imageVersion
#         value: $(major).$(minor).$(GitBuildNumber).$(TIME)
#       jobs:
#       - template: templates/images-template.yml
#         parameters:
#           registryName: $(registryName)
#           pipelineAcrConnection: $(pipelineAcrConnection)
#           selectedImage: ${{ img.name }}
#           imageVersion: $(imageVersion)
#     - stage: CleanBuildScanPush
#       displayName: Build Tag Scan Push Image
#       dependsOn: 
#       - ProcessImage_${{ img.name }}  
#       variables:
#       - name: imageName
#         value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageName'] ]
#       - name: imageVersion
#         value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imageVersion'] ]
#       - name: imagePath
#         value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.imagePath'] ]
#       - name: dockerFilePath
#         value: $[ stageDependencies.ProcessImage_${{ img.name }}.RetrieveInfo_${{ img.name }}.outputs['setImageInfo.dockerFilePath'] ]      
#       jobs:
#       - job: CleanImages
#         displayName: Clean Images & Containers
#         pool:
#           name: $(AGENT_POOL)
#           agent.name: aks-${{parameters.env}}-agent
#         steps:
#         - template: templates/clean.yml              

#       - job: BuildImageJob  
#         displayName: Build ${{img.name}} Image
#         dependsOn:
#         - CleanImages
#         pool:
#           name: $(AGENT_POOL)
#           agent.name: aks-${{parameters.env}}-agent
#         steps:
#         - script: |
#             echo "##[group]BuildImageVars"
#             echo "##[command]imageName:\t $(imageName)"
#             echo "##[command]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"        
#           #   echo "Debugging BuildImage variables:"
#           #   echo "imageName: $(imageName)"
#           #   echo "imageVersion: $(imageVersion)"
#           name: DebugPrint
#         - template: templates/build.yml
#           parameters:
#             imageName: $(imageName)
#             imageVersion: $(imageVersion)
#             imagePath: $(imagePath)
#             dockerFilePath: $(dockerFilePath)
#             registryName: $(registryName)
#             pipelineAcrConnection: $(pipelineAcrConnection)
#       - job: ScanImageJob
#         dependsOn: BuildImageJob 
#         displayName: Scan ${{img.name}} Image 
#         pool:
#           name: $(AGENT_POOL)
#           agent.name: aks-${{parameters.env}}-agent
#         # variables:
#         # - name: imageName
#         #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#         # - name: imageVersion
#         #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#         # - name: imagePath
#         #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#         # - name: dockerFilePath
#         #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]
#         steps:
#         - script: |
#             echo "##[group]ScanImageVars"
#             echo "##[command]imageName:\t $(imageName)"
#             echo "##[command]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"            
#           name: DebugPrint
#         - template: templates/scan.yml
#           parameters:
#             imageName: $(imageName)
#             imageVersion: $(imageVersion)
#             registryName: $(registryName)

#       - job: PushImageJob  
#         displayName: Push ${{img.name}} Image 
#         dependsOn: ScanImageJob
#         pool:
#           name: $(AGENT_POOL)
#           agent.name: aks-${{parameters.env}}-agent
#         steps:
#         - script: |
#             echo "##[group]PushImageVars"
#             echo "##[command]imageName:\t $(imageName)"
#             echo "##[command]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageVersion:\t $(imageVersion)"
#             echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"            
#           name: DebugPrint    
#         - template: templates/push.yml
#           parameters:
#             imageName: $(imageName)
#             imageVersion: $(imageVersion)
#             registryName: $(registryName)

# - ${{ if ne(parameters.image, 'all') }}:
#   - stage: ProcessSingleImage_${{ parameters.image }}
#     displayName: Retrieve ${{ parameters.image }} Information
#     variables:
#     - name: imageVersion
#       value: $(major).$(minor).$(GitBuildNumber).$(TIME)
#     jobs:
#     - template: templates/images-template.yml
#       parameters:
#         registryName: $(registryName)
#         pipelineAcrConnection: $(pipelineAcrConnection)
#         selectedImage: ${{ parameters.image }}
#         imageVersion: $(imageVersion)
#   - stage: CleanBuildScanPush
#     displayName: Build Tag Scan Push Image
#     dependsOn: 
#     - ProcessSingleImage_${{ parameters.image }}  
#     variables:
#     - name: imageName
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#     - name: imageVersion
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#     - name: imagePath
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#     - name: dockerFilePath
#       value: $[ stageDependencies.ProcessSingleImage_${{ parameters.image }}.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]      
#     jobs:
#     - job: CleanImages
#       displayName: Clean Images & Containers
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - template: templates/clean.yml              

#     - job: BuildImageJob  
#       displayName: Build ${{parameters.image}} Image
#       dependsOn:
#       - CleanImages
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]BuildImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"        
#         name: DebugPrint
#       - template: templates/build.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           imagePath: $(imagePath)
#           dockerFilePath: $(dockerFilePath)
#           registryName: $(registryName)
#           pipelineAcrConnection: "$(pipelineAcrConnection)"
#     - job: ScanImageJob
#       dependsOn: BuildImageJob 
#       displayName: Scan ${{parameters.image}} Image 
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       # variables:
#       # - name: imageName
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageName'] ]
#       # - name: imageVersion
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imageVersion'] ]
#       # - name: imagePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.imagePath'] ]
#       # - name: dockerFilePath
#       #   value: $[ stageDependencies.RetrieveImageInfo.RetrieveImageInfoJob.outputs['setImageInfo.dockerFilePath'] ]
#       steps:
#       - script: |
#           echo "##[group]ScanImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#           echo "##[endgroup]"            
#         name: DebugPrint
#       - template: templates/scan.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)

#     - job: PushImageJob  
#       displayName: Push ${{parameters.image}} Image 
#       dependsOn: ScanImageJob
#       pool:
#         name: $(AGENT_POOL)
#         agent.name: aks-${{parameters.env}}-agent
#       steps:
#       - script: |
#           echo "##[group]PushImageVars"
#           echo "##[command]imageName:\t $(imageName)"
#           echo "##[command]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageVersion:\t $(imageVersion)"
#           echo "##[warning]imageName:\t $(imageName)"
#             echo "##[endgroup]"        
#         name: DebugPrint    
#       - template: templates/push.yml
#         parameters:
#           imageName: $(imageName)
#           imageVersion: $(imageVersion)
#           registryName: $(registryName)







# stages:
# - stage: RetrieveImages
#   condition: eq(parameters.image, 'all') # Only run this stage if "all" is selected
#   jobs:
#   - job: GetImages
#     displayName: Get All Images
#     steps:
#     - template: templates/get-images.yml
#       parameters:
#         registryName: $(registryName)
#         pipelineAcrConnection: $(pipelineAcrConnection)


# - stage: ProcessImages
#   jobs:
#   - template: templates/images-template.yml
#     parameters:
#       registryName: $(registryName)
#       pipelineAcrConnection: $(pipelineAcrConnection)
#       selectedImage: ${{ parameters.image }} # 'all' or specific image name
#       imageVersion: $(imageVersion)
